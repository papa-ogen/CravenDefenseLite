<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EasyStar JS</title>
</head>
<body>
    
    <script src='js/vendor/easystar-0.3.0.min.js'></script>
    <script src='js/vendor/phaser.min.js'></script>    
    <script>
            
var game = new Phaser.Game(320, 320, Phaser.CANVAS, 'gameContainer', { preload: preload, create: create, update: update, render: render });

function preload() {

    game.load.tilemap('map', 'assets/maps/easystar.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.image('tiles', 'assets/maps/floor_tileset.png');
    game.load.image("monster1", "assets/images/monster1.png");

}

var map, layer, foreground, toplayer, sprite,
    easystar, endX, endY, currentTileX, currentTileY,
    grid = [], acceptableTile, marker = {};

function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE);

    map = game.add.tilemap('map');
    map.addTilesetImage('floor_tileset', 'tiles');
    
    layer = map.createLayer('Background');
    layer.resizeWorld();
    
    easystar = new EasyStar.js();

    acceptableTile = 3;
    grid = createGrid(map.layers[0].data);
    
    easystar.setGrid(grid);
    easystar.setAcceptableTiles([acceptableTile]);
    easystar.enableCornerCutting();
    easystar.enableDiagonals();

//    easystar.setIterationsPerCalculation(1000);

    sprite = game.add.sprite(300, 50, 'monster1');
    sprite.anchor.setTo(0.5, 0.5);

    game.physics.enable(sprite);
    
    sprite.body.velocity.x = -10;
    
    currentTileX =  layer.getTileX(sprite.x);
    currentTileY = layer.getTileY(sprite.y);
    console.log(currentTileX, currentTileY);

    game.camera.follow(sprite);
    
}

function createGrid (data) {
    
    var grid = [];
    
    for (var i = 0; i < data.length; i++) {
        
        grid[i] = [];
        
        for (var j = 0; j < data[i].length; j++) {

            if (data[i][j].index === acceptableTile) {
                
                grid[i][j] = acceptableTile;
                
            } else  {
                
                grid[i][j] = 0;
                
            }
            
        }
        
    }
    
    return grid;
}

function update() {
    
    game.physics.arcade.collide(sprite, layer);
    
    currentTileX =  layer.getTileX(sprite.x);
    currentTileY = layer.getTileY(sprite.y);
    
    easystar.findPath(currentTileX, currentTileY, 9, 0, findPath);
    
    easystar.calculate();

}

function findPath (path) {
    
    if (path === null) {
        
        sprite.body.velocity.x = 0;
        sprite.body.velocity.y = 0;
        
        console.log("Path was not found.");
        
    } else {
        
        console.log("Path was found. The first Point is " + path[0].x + " " + path[0].y, path);
        
        var tile = map.getTile(path[0].x, path[0].y, layer); 
        
        if(game.physics.arcade.distanceToXY(sprite, tile.worldX, tile.worldX) >= 4) {

            game.physics.arcade.moveToXY(sprite, tile.worldX, tile.worldX, 50);
            
        }

    }
}

function render() {

}
    </script>
</body>
</html>